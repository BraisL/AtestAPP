<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AtestApp - Diligencia libre</title>

  <link rel="stylesheet" href="../css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    /* Layout del formulario */
    .dl-wrap { padding: 0vw; max-width: 80vw; margin: 0 auto; }
    .dl-title { margin: 0.83em 0 0.83em 0; }
    .dl-help { margin: 0.2vw 0 1vw 0; line-height: 1.35; }

    .dl-link {
      color: inherit;
      text-decoration: underline;
      text-decoration-style: dotted;
      cursor: pointer;
      font-weight: 600;
    }
    .dl-link:hover { font-weight: 700; text-decoration-style: solid; }

    .dl-card {
      border: 0.15vw solid #ccc;
      border-radius: 0.25vw;
      padding: 1vw;
      background: #fff;
    }

    .dl-fields {
      display: flex;
      flex-wrap: wrap;
      gap: 1vw;
      align-items: flex-start;
    }

    .dl-field { display: flex; flex-direction: column; }
    .dl-field label { margin-bottom: 0.35vw; }
    .dl-field input, .dl-field textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 0.55vw;
      border: 0.15vw solid #ccc;
      border-radius: 0.25vw;
      font-family: 'Montserrat', sans-serif;
      font-size: 0.9vw;
    }
    .dl-field textarea { resize: vertical; min-height: 18vh; }

    .w-20 { min-width: 12vw; max-width: 12vw; }
    .w-30 { min-width: 18vw; max-width: 18vw; }
    .w-60 { min-width: 30vw; max-width: 30vw; }
    .w-100 { min-width: 100%; max-width: 100%; }

    .dl-actions {
      margin-top: 1.2vw;
      display: flex;
      flex-wrap: wrap;
      gap: 1vw;
    }

    /* Documento imprimible (A4 real) */
    #printArea { display: none; }

    .doc-pages { display: grid; gap: 0; justify-content: center; }
    .sheet {
      position: relative;
      width: 210mm;
      height: 297mm;
      background: white;
      box-shadow: 0 1.2vh 3vh rgba(0,0,0,0.35);
      overflow: hidden;
    }

    .sheet-bg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: fill;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      z-index: 0;
    }

    .overlay { position: absolute; inset: 0; z-index: 1; }

    .field {
      position: absolute;
      color: #000;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: 'Montserrat', sans-serif;
      font-size: 11pt;
      line-height: 1.25;
    }
    /* Posiciones impresión */
    .field-atestado { top: 5.5%; left: 31.0%; width: 18%; height: 1%; font-weight: 500; font-size: 85%; font-family: math; text-align: center;}
    .field-folio    { top: 5.6%; left: 88.5%; width: 3.5%; height: 1%; font-weight: 500; font-size: 80%; font-family: math; text-align: center;}

    .field-titulo { top: 10.0%; left: 20.0%; width: 70%; height: 2.0%; font-weight: 700; font-size: 100%;  text-align: center; }
    .field-texto    { top: 14%; left: 20.0%; width: 70%; height: 78.0%; }

    /* === Hojas 2+ (sin título): aprovechar el hueco superior sin tocar números === */
    :root{
      --dl-top-titulo: 10.0%;
      --dl-top-texto: 14%;
      --dl-alto-texto: 78.0%;
    }
    .sheet.sin-titulo .field-texto{
      top: var(--dl-top-titulo);
      height: calc(var(--dl-alto-texto) + (var(--dl-top-texto) - var(--dl-top-titulo)));
    }

    /* Seguridad: evita que se solape con el footer si algo excede */
    .field-texto{ overflow: hidden; }

    .field-footer { top: 94.15%; left: 20.0%; width: 70%; height: 2%; font-size: 35%; }
    .field-texto .parrafo{
      margin: 0 0 0.55em 0;
      text-indent: 2.5em;   /* el “tab” */
    }

    .field-footer{
      line-height: 1.1;
    }

    .field-footer .pie-unidad{
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1mm;
    }

    .field-footer .pie-linea{ width: 100%; }

    .field-footer .pie-linea1{
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      column-gap: 5mm;
      align-items: baseline;
    }

    .field-footer .pie-linea2{
      display: flex;
      flex-wrap: wrap;
      gap: 0 5mm;
      align-items: baseline;
    }

    .field-footer .pie-bloque{ white-space: nowrap; }
    .field-footer .pie-etiqueta{ font-weight: 400; white-space: nowrap; }
    .field-footer .pie-valor{ font-weight: 400; }
    .field-footer .pie-bloque.pie-email .pie-valor{ text-transform: none; }

    .field.field-fuerza {color: transparent;}
    .field.field-tips {color: transparent;}
    
    /* El texto base mantiene saltos de línea como antes */
    .field-texto .texto-base{
      white-space: pre-wrap;
    }

    /* “La Fuerza Instructora:” centrado, con separación */
    .field-texto .bloque-fuerza{
      margin-top: 12mm;   /* súbelo/bájalo aquí */
      text-align: center;
      font-weight: 600;
    }

    /* Tips en cajas, centradas */
    .field-texto .bloque-tips{
      margin-top: 15mm;    /* separación respecto a “Fuerza” */
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 3mm;
    }

    .field-texto .tip-box{
      padding: 1.2mm 2.2mm;
      line-height: 1.1;
      font-weight: 600;
      font-size: 10pt;
    }

    /* TIPS (no invasivo) */
    .dl-field-nombre-tip .dl-nombre-tip-labels{
      display:grid;
      grid-template-columns: 1fr 0.65fr;
      gap: 1vw;
      align-items:end;
    }
    .dl-field-nombre-tip .dl-nombre-tip-inputs{
      display:grid;
      grid-template-columns: 1fr 0.65fr;
      gap: 1vw;
      align-items:center;
    }
    .dl-tip-inputwrap{
      display:flex;
      gap: 0.6vw;
      align-items:center;
    }
    .dl-tip-inputwrap input{ flex: 1; }
    
    .dl-tip-add{
      border: 0.1vw solid transparent;
      cursor: pointer;

      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: -2.5vw;
      padding: 0;
      background: transparent;
    }

    .dl-tip-add i{
      font-size: 0.95vw; /* ajusta si lo ves grande/pequeño */
      line-height: 1;
    }

    .dl-tip-add:hover{ color: #348139; }

    details.dl-tips-details{
      margin-top: 1vw;
      padding: 0.7vw 0.8vw;
      border: 0.15vw solid #ddd;
      border-radius: 0.25vw;
      background: #fafafa;
    }
    details.dl-tips-details > summary{
      cursor: pointer;
      user-select: none;
      font-weight: 700;
      list-style: none;
      font-size: 0.85vw;
    }
    details.dl-tips-details > summary::-webkit-details-marker{ display:none; }

    .dl-tips-list{
      margin-top: 0.8vw;
      display:flex;
      gap: 0.6vw;
      max-height: 5vh;
      overflow: auto;
      padding-right: 0.4vw;
    }
    .dl-tip-item{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 0.8vw;
      border: 0.15vw solid #e3e3e3;
      border-radius: 0.25vw;
      padding: 0.55vw;
      background: #fff;
    }
    .dl-tip-text{
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .dl-tip-remove{
      border: 0.15vw solid #854242;
      border-radius: 0.25vw;
      min-width: 1.5vw;
      max-width: 1.5vw;
      height: 1.5vw;
      cursor: pointer;
      line-height: 1;
      font-size: 1vw;
      color: #854242;
    }
    .dl-tip-remove:hover{ background: #854242; color: #000}

    /* Impresión */
    @page { size: A4; margin: 0; }
    @media print {
      * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      html, body { width: 210mm; height: 297mm; margin: 0; padding: 0; background: #fff; }
      body { min-width: 0 !important; min-height: 0 !important; overflow: visible !important; }

      .dl-card, .dl-help, .dl-title, .dl-actions, .warnings { display: none !important; }
      #printArea { display: block !important; }

      .sheet { box-shadow: none; page-break-after: always; }
      .sheet:last-child { page-break-after: auto; }
    }
  </style>
</head>

<body class="page">
  <main class="dl-wrap">
    <h2 class="dl-title">Diligencia libre</h2>

    <p class="dl-help">
      Rellena los campos y pulsa <strong>IMPRIMIR (PDF)</strong>. El navegador abrirá el diálogo de impresión; selecciona “Guardar como PDF”.
      Si ya tienes una diligencia guardada en <strong>.json</strong>, puedes <a class="dl-link" href="#" id="linkLoadJson">cargarla aquí</a>.
    </p>

    <input type="file" id="fileLoadJson" accept=".json" style="display:none;">

    <section class="dl-card">
      <div class="dl-fields">
        <div class="dl-field w-30">
          <label for="dlAtestado"><strong>Número de atestado</strong></label>
          <input id="dlAtestado" name="atestado" type="text" placeholder="Ej. 2026-337-000XXX">
        </div>

        <div class="dl-field w-20">
          <label for="dlFolio"><strong>Folio</strong></label>
          <input id="dlFolio" name="folio" type="text" placeholder="Ej. 1">
        </div>

        <div class="dl-field w-60 dl-field-nombre-tip">
          <div class="dl-nombre-tip-labels">
            <label for="dlNombre"><strong>Nombre de la diligencia *</strong></label>
            <label for="dlTipInput"><strong>TIP</strong></label>
          </div>

          <div class="dl-nombre-tip-inputs">
            <input id="dlNombre" name="nombre" type="text" placeholder="Ej. Exposición de hechos" required>

            <div class="dl-tip-inputwrap">
              <input id="dlTipInput" type="text" placeholder="Añadir TIP" autocomplete="off">
              <button id="btnAddTip" class="dl-tip-add" type="button" title="Añadir TIP">
                <i class="fa-solid fa-user-plus" aria-hidden="true"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="dl-field w-100">
          <label for="dlTexto"><strong>Texto</strong></label>
          <textarea id="dlTexto" name="texto" placeholder="Escribe aquí el texto..."></textarea>
        </div>
      </div>

      <details id="tipsDetails" class="dl-tips-details" style="display:none;">
        <summary>TIPs añadidas - <span id="tipsCount">0</span></summary>
        <div id="tipsList" class="dl-tips-list"></div>
      </details>


      <div class="dl-actions">
        <button id="btnImprimir" type="button">IMPRIMIR (PDF)</button>
        <button id="btnDownloadJson" type="button">DESCARGAR (.JSON)</button>
      </div>

      <div class="warnings" style="margin-top: 14px;">
        <p style="margin: 10px 0;"><strong>Explicación rápida</strong></p>
        <p style="margin: 6px 0;"><strong>Imprimir</strong> abre el diálogo del navegador (ahí podrás guardarla como PDF o imprimir el documento físico). Si el texto no cabe se generan páginas adicionales automáticamente.</p>
        <p style="margin: 6px 0;"><strong>Descargar</strong> guarda esta diligencia en un .json para poder cargarla más adelante o compartirla.</p>
      </div>
    </section>

    <!-- Se muestra SOLO al imprimir -->
    <section id="printArea">
      <div id="printPages" class="doc-pages"></div>
    </section>
  </main>

  <script src="../js/utilidades.js"></script>
  <script src="../js/diligencialibre.js"></script>
  <script src="../js/iframe_autoaltura.js"></script>
</body>
</html>
